{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Chat de Usuarios</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: #333;
            color: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .conversations-container {
            display: flex;
            gap: 20px;
        }
        
        .conversations-list {
            width: 300px;
            background: white;
            border-radius: 5px;
            padding: 15px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .conversation-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            margin-bottom: 5px;
        }
        
        .conversation-item:hover {
            background-color: #f0f0f0;
        }
        
        .conversation-item.active {
            background-color: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        
        .chat-area {
            flex: 1;
            background: white;
            border-radius: 5px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 70vh;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
        }
        
        .user-message {
            background-color: #e3f2fd;
            margin-right: auto;
        }
        
        .admin-message {
            background-color: #f0f0f0;
            margin-left: auto;
        }
        
        .reply-form {
            display: flex;
            gap: 10px;
        }
        
        .reply-form input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .reply-form button {
            padding: 10px 20px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .reply-form button:hover {
            background-color: #1976d2;
        }

        /* Estilos para la info del presupuesto */
        .presupuesto-info {
            background: linear-gradient(135deg, #fff5f5 0%, #ffeef0 100%);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffd4f0;
            margin-bottom: 20px;
            border: 1px solid #ffd4f0;
        }

        .presupuesto-info h5 {
            color: #522b0b;
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .presupuesto-info p {
            margin: 5px 0;
            color: #522b0b;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .btn-sm {
            padding: 6px 12px;
        }

        .btn-latte {
            background: linear-gradient(135deg, #522b0b 0%, #8D6E63 100%);
            color: white;
        }

        .btn-latte:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(82, 43, 11, 0.3);
        }

        .budget-badge {
            background: #ffd4f0;
            color: #522b0b;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Administraci贸n de Chat de Usuarios</h1>
        <p>Bienvenido, {{ user.username }} | <a href="{% url 'account_logout' %}" style="color: white;">Cerrar sesi贸n</a></p>
    </div>
    
    {% csrf_token %}
    
    <div class="conversations-container">
        <div class="conversations-list">
            <h3>Conversaciones</h3>
            {% for email, data in conversations %}
                <div class="conversation-item" onclick="loadConversation('{{ email }}', '{{ data.sender_name }}', event)">
                    <strong>{{ data.sender_name }}</strong>
                    {% if data.tiene_presupuestos %}
                    <span class="budget-badge" title="Tiene presupuestos relacionados"></span>
                    {% endif %}
                    <br>
                    <small>{{ email }}</small>
                </div>
            {% empty %}
                <p>No hay mensajes de usuarios</p>
            {% endfor %}
        </div>
        
        <div class="chat-area">
            <!-- Secci贸n de informaci贸n del presupuesto (se mostrar谩 din谩micamente) -->
            <div id="presupuestoInfo" class="presupuesto-info" style="display: none;">
                <!-- La informaci贸n del presupuesto se cargar谩 aqu铆 -->
            </div>
            
            <div id="chatMessages" class="chat-messages">
                <p id="select-conversation">Selecciona una conversaci贸n para ver los mensajes</p>
            </div>
            <div class="reply-form">
                <input type="text" id="replyMessage" placeholder="Escribe tu respuesta..." disabled>
                <button onclick="sendAdminReply()" id="sendReplyBtn" disabled>Responder</button>
            </div>
        </div>
    </div>

    <script>
        let currentEmail = null;
        let currentSenderName = null;
        let latestMessageTimestamp = null;
        let pollingInterval = null;

        function loadConversation(email, senderName, event) {
            // Stop polling for the previous conversation
            stopPolling();
            
            currentEmail = email;
            currentSenderName = senderName;
            
            // Highlight selected conversation
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            // Enable reply form
            document.getElementById('replyMessage').disabled = false;
            document.getElementById('sendReplyBtn').disabled = false;
            
            // Load messages for this conversation
            fetch(`/api/chat/messages/${email}/`)
                .then(response => response.json())
                .then(messages => {
                    displayMessages(messages);
                    
                    // Buscar si hay mensajes con presupuestos relacionados
                    cargarInformacionPresupuestos(messages);
                    
                    // Track the latest message timestamp
                    latestMessageTimestamp = null;
                    if (messages.length > 0) {
                        messages.forEach(msg => {
                            if (!latestMessageTimestamp || msg.timestamp > latestMessageTimestamp) {
                                latestMessageTimestamp = msg.timestamp;
                            }
                        });
                    }
                    
                    // Start polling for new messages
                    startPolling();
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    startPolling();
                });
        }

        function cargarInformacionPresupuestos(messages) {
            const presupuestoInfoDiv = document.getElementById('presupuestoInfo');
            presupuestoInfoDiv.style.display = 'none';
            presupuestoInfoDiv.innerHTML = '';
            
            // Buscar mensajes que tengan informaci贸n de presupuesto
            const mensajesConPresupuesto = messages.filter(msg => 
                msg.presupuesto_relacionado || 
                (msg.message && msg.message.includes('presupuesto'))
            );
            
            if (mensajesConPresupuesto.length > 0) {
                // Tomar el primer mensaje con presupuesto
                const mensaje = mensajesConPresupuesto[0];
                
                if (mensaje.presupuesto_relacionado) {
                    const presupuesto = mensaje.presupuesto_relacionado;
                    presupuestoInfoDiv.innerHTML = `
                        <h5> Presupuesto Relacionado: #${presupuesto.id}</h5>
                        <p><strong>Cliente:</strong> ${presupuesto.customer_name}</p>
                        <p><strong>Total:</strong> $${presupuesto.total_amount}</p>
                        <p><strong>T铆tulo:</strong> ${presupuesto.title}</p>
                        <a href="/budgets/${presupuesto.id}/" target="_blank" class="btn btn-latte btn-sm">
                            Ver Presupuesto Completo
                        </a>
                    `;
                    presupuestoInfoDiv.style.display = 'block';
                } else if (mensaje.message && mensaje.message.includes('presupuesto')) {
                    // Si no hay presupuesto relacionado pero el mensaje menciona "presupuesto"
                    presupuestoInfoDiv.innerHTML = `
                        <h5> Conversaci贸n sobre presupuesto</h5>
                        <p>El usuario est谩 consultando sobre un presupuesto. P铆dele que comparta el n煤mero de presupuesto o env铆alo desde el sistema.</p>
                        <a href="/admin/todos-presupuestos/" target="_blank" class="btn btn-latte btn-sm">
                            Buscar Presupuestos
                        </a>
                    `;
                    presupuestoInfoDiv.style.display = 'block';
                }
            }
        }

        function displayMessages(messages) {
            const chatDiv = document.getElementById('chatMessages');
            chatDiv.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.message_type === 'user' ? 'user-message' : 'admin-message'}`;
                
                const sender = msg.message_type === 'user' ? 'Usuario' : 'Admin';
                
                let contentHTML = `<strong>${sender}:</strong> `;
                
                // Add message text if available
                if (msg.message) {
                    contentHTML += ` ${msg.message}`;
                } else if (msg.image_url) {
                    contentHTML += ` [Imagen]`;
                }
                
                // Add image if available
                if (msg.image_url) {
                    contentHTML += `<br><img src="${msg.image_url}" alt="Imagen del mensaje" style="max-width: 200px; border-radius: 8px; margin-top: 5px;">`;
                }
                
                // Mostrar badge si tiene presupuesto relacionado
                if (msg.presupuesto_relacionado) {
                    contentHTML += ` <span class="budget-badge" title="Presupuesto #${msg.presupuesto_relacionado.id}"></span>`;
                }
                
                contentHTML += `<br><small>${new Date(msg.timestamp).toLocaleString()}</small>`;
                
                messageDiv.innerHTML = contentHTML;
                chatDiv.appendChild(messageDiv);
            });
            
            setTimeout(() => {
                chatDiv.scrollTop = chatDiv.scrollHeight;
            }, 100);
        }
        
        function addMessageToChat(msg) {
            const chatDiv = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.message_type === 'user' ? 'user-message' : 'admin-message'}`;
            
            const sender = msg.message_type === 'user' ? 'Usuario' : 'Admin';
            
            let contentHTML = `<strong>${sender}:</strong> `;
            
            if (msg.message) {
                contentHTML += ` ${msg.message}`;
            } else if (msg.image_url) {
                contentHTML += ` [Imagen]`;
            }
            
            if (msg.image_url) {
                contentHTML += `<br><img src="${msg.image_url}" alt="Imagen del mensaje" style="max-width: 200px; border-radius: 8px; margin-top: 5px;">`;
            }
            
            // Mostrar badge si tiene presupuesto relacionado
            if (msg.presupuesto_relacionado) {
                contentHTML += ` <span class="budget-badge" title="Presupuesto #${msg.presupuesto_relacionado.id}"></span>`;
            }
            
            contentHTML += `<br><small>${new Date(msg.timestamp).toLocaleString()}</small>`;
            
            messageDiv.innerHTML = contentHTML;
            chatDiv.appendChild(messageDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            
            if (!latestMessageTimestamp || msg.timestamp > latestMessageTimestamp) {
                latestMessageTimestamp = msg.timestamp;
            }
        }

        function startPolling() {
            stopPolling();
            
            pollingInterval = setInterval(async () => {
                if (!currentEmail) {
                    stopPolling();
                    return;
                }
                
                try {
                    let url = `/api/chat/messages/${currentEmail}/`;
                    if (latestMessageTimestamp) {
                        url += `?since=${encodeURIComponent(latestMessageTimestamp)}`;
                    }
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const newMessages = await response.json();
                    
                    if (Array.isArray(newMessages) && newMessages.length > 0) {
                        newMessages.forEach(msg => {
                            addMessageToChat(msg);
                        });
                        
                        // Actualizar informaci贸n de presupuestos si llegan nuevos mensajes
                        if (newMessages.some(msg => msg.presupuesto_relacionado)) {
                            fetch(`/api/chat/messages/${currentEmail}/`)
                                .then(response => response.json())
                                .then(allMessages => {
                                    cargarInformacionPresupuestos(allMessages);
                                });
                        }
                    }
                } catch (error) {
                    console.error('Error polling for new messages:', error);
                }
            }, 3000);
        }
        
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        function sendAdminReply() {
            const replyMessage = document.getElementById('replyMessage').value;
            if (!replyMessage.trim() || !currentEmail) {
                alert('Por favor escribe un mensaje y selecciona una conversaci贸n');
                return;
            }

            fetch(`/api/chat/messages/${currentEmail}/`)
                .then(response => response.json())
                .then(messages => {
                    const originalMessage = messages.filter(msg => msg.message_type === 'user').pop();
                    
                    if (!originalMessage) {
                        alert('No se encontr贸 el mensaje original para responder');
                        return;
                    }

                    fetch('/api/chat/reply/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({
                            message: replyMessage,
                            original_message: originalMessage.id
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.id) {
                            document.getElementById('replyMessage').value = '';
                            loadConversation(currentEmail, currentSenderName);
                        } else {
                            alert('Error al enviar la respuesta: ' + (data.error || 'Error desconocido'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al enviar la respuesta');
                    });
                })
                .catch(error => {
                    console.error('Error finding original message:', error);
                });
        }

        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
        
        window.addEventListener('beforeunload', stopPolling);
        window.addEventListener('pagehide', stopPolling);
    </script>
</body>
</html>