{% extends "base.html" %}

{% block content %}
<style>
.edit-budget-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    padding: 3rem 2rem;
    background: linear-gradient(to bottom, #fce4ec 0%, #f8f9fa 100%);
    min-height: calc(100vh - 200px);
}

.edit-header {
    text-align: center;
    margin-bottom: 3rem;
}

.page-title-edit {
    font-size: 2.5rem;
    color: #333;
    font-weight: 300;
    letter-spacing: 1px;
}

.edit-layout {
    display: grid;
    grid-template-columns: 1fr 450px;
    gap: 2rem;
    align-items: start;
}

.form-section {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.section-title-edit {
    font-size: 1.5rem;
    color: #333;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #fce4ec;
}

.form-group-edit {
    margin-bottom: 1.5rem;
}

.form-label-edit {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #555;
    font-size: 0.95rem;
}

.form-input-edit {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e8e8e8;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background-color: #fafafa;
}

.form-input-edit:focus {
    outline: none;
    border-color: #ff6b93;
    background-color: white;
    box-shadow: 0 0 0 3px rgba(255, 107, 147, 0.1);
}

/* Productos más compactos */
.products-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-top: 1rem;
}

.product-card-compact {
    background: #fafafa;
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    gap: 1rem;
    align-items: center;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.product-card-compact:hover {
    border-color: #ff6b93;
    background: white;
}

.product-image-compact {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
    flex-shrink: 0;
}

.product-image-placeholder-compact {
    width: 60px;
    height: 60px;
    background: #e0e0e0;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: #999;
    flex-shrink: 0;
}

.product-info-compact {
    flex: 1;
    min-width: 0;
}

.product-name-compact {
    font-size: 0.95rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.product-price-compact {
    font-size: 0.9rem;
    color: #d81b60;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.product-actions-compact {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.quantity-input-compact {
    width: 50px;
    padding: 0.25rem 0.5rem;
    border: 2px solid #e8e8e8;
    border-radius: 6px;
    text-align: center;
    font-size: 0.9rem;
}

.btn-add-compact {
    padding: 0.375rem 0.75rem;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.btn-add-compact:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

/* Sidebar con presupuesto actual */
.budget-current-section {
    position: sticky;
    top: 2rem;
}

.current-budget-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 1.5rem;
}

.budget-items-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.budget-item {
    padding: 1rem;
    background: #fafafa;
    border-radius: 10px;
    margin-bottom: 0.75rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.item-info {
    flex: 1;
}

.item-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.25rem;
}

.item-details {
    font-size: 0.85rem;
    color: #666;
}

.item-actions {
    text-align: right;
}

.item-subtotal {
    font-size: 1.1rem;
    color: #d81b60;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.btn-remove {
    padding: 0.25rem 0.75rem;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
}

.btn-remove:hover {
    background: #c82333;
}

.budget-total-card {
    background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 1.5rem;
}

.total-text {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.5rem;
}

.total-amount-edit {
    font-size: 2rem;
    color: #d81b60;
    font-weight: 700;
}

.actions-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.btn-submit-edit {
    width: 100%;
    padding: 1rem;
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn-submit-edit:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

.btn-cancel-edit {
    width: 100%;
    padding: 1rem;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn-cancel-edit:hover {
    background: #5a6268;
    color: white;
}

.empty-budget {
    text-align: center;
    padding: 2rem;
    color: #888;
}

@media (max-width: 1200px) {
    .products-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 1024px) {
    .edit-layout {
        grid-template-columns: 1fr;
    }
    
    .budget-current-section {
        position: static;
    }
}

@media (max-width: 768px) {
    .edit-budget-wrapper {
        padding: 2rem 1rem;
    }
}
</style>

<div class="edit-budget-wrapper">
    <div class="edit-header">
        <h1 class="page-title-edit">Editar Presupuesto</h1>
    </div>

    <form method="post">
        {% csrf_token %}
        
        <div class="edit-layout">
            <!-- Columna Izquierda: Formulario y Productos -->
            <div>
                <!-- Datos básicos -->
                <div class="form-section">
                    <h2 class="section-title-edit">Información del Presupuesto</h2>
                    
                    <div class="form-group-edit">
                        <label for="title" class="form-label-edit">Título del Presupuesto</label>
                        <input type="text" class="form-input-edit" id="title" name="title" value="{{ budget.title }}" required>
                    </div>
                    
                    <div class="form-group-edit">
                        <label for="customer_name" class="form-label-edit">Nombre del Cliente</label>
                        <input type="text" class="form-input-edit" id="customer_name" name="customer_name" value="{{ budget.customer_name }}" required>
                    </div>
                    
                    <div class="form-group-edit">
                        <label for="customer_email" class="form-label-edit">Email del Cliente</label>
                        <input type="email" class="form-input-edit" id="customer_email" name="customer_email" value="{{ budget.customer_email }}" required>
                    </div>
                </div>

                <!-- Productos disponibles -->
                <div class="form-section" style="margin-top: 2rem;">
                    <h2 class="section-title-edit">Agregar Productos</h2>
                    <div class="products-grid">
                        {% for product in products %}
                        <div class="product-card-compact">
                            {% if product.imagen %}
                            <img src="{{ product.imagen.url }}" class="product-image-compact" alt="{{ product.nombre }}">
                            {% else %}
                            <div class="product-image-placeholder-compact">
                                Sin Imagen
                            </div>
                            {% endif %}
                            
                            <div class="product-info-compact">
                                <div class="product-name-compact" title="{{ product.nombre }}">{{ product.nombre }}</div>
                                <div class="product-price-compact">${{ product.precio }}</div>
                                <div class="product-actions-compact">
                                    <input type="number" min="1" value="1" class="quantity-input-compact">
                                    <button type="button" class="btn-add-compact add-to-budget" 
                                            data-product-id="{{ product.id }}" 
                                            data-product-name="{{ product.nombre }}"
                                            data-product-price="{{ product.precio }}">
                                        + Añadir
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Presupuesto Actual -->
            <div class="budget-current-section">
                <div class="current-budget-card">
                    <h3 class="section-title-edit">Presupuesto Actual</h3>
                    <div id="budget-items">
                        <div class="empty-budget">Cargando productos...</div>
                    </div>
                </div>

                <div id="budget-total-display" style="display: none;">
                    <div class="budget-total-card">
                        <div class="total-text">Total a pagar:</div>
                        <div class="total-amount-edit" id="total-display">$0.00</div>
                    </div>
                </div>

                <div class="actions-buttons">
                    <div id="hidden-fields-container"></div>
                    <button type="submit" class="btn-submit-edit">
                        <i class="bi bi-check-circle"></i> Actualizar Presupuesto
                    </button>
                    <a href="{% url 'view_budget' budget.id %}" class="btn-cancel-edit">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    const existingItems = [
        {% for item in budget.items.all %}
        {
            id: "{{ item.product.id }}",
            name: "{{ item.product.nombre }}",
            price: parseFloat("{{ item.price }}"),
            quantity: {{ item.quantity }}
        },
        {% endfor %}
    ];
    
    let selectedItems = [...existingItems];
    
    function updateBudgetDisplay() {
        const container = document.getElementById('budget-items');
        const totalDisplay = document.getElementById('budget-total-display');
        
        if (selectedItems.length === 0) {
            container.innerHTML = '<div class="empty-budget">Añade productos para comenzar...</div>';
            document.getElementById('hidden-fields-container').innerHTML = '';
            totalDisplay.style.display = 'none';
            return;
        }
        
        totalDisplay.style.display = 'block';
        
        let html = '<ul class="budget-items-list">';
        let total = 0;
        
        selectedItems.forEach(item => {
            const subtotal = item.price * item.quantity;
            total += subtotal;
            
            html += `
                <li class="budget-item">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-details">$${item.price.toFixed(2)} × ${item.quantity}</div>
                    </div>
                    <div class="item-actions">
                        <div class="item-subtotal">$${subtotal.toFixed(2)}</div>
                        <button type="button" class="btn-remove remove-item" data-product-id="${item.id}">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    </div>
                </li>
            `;
        });
        
        html += '</ul>';
        container.innerHTML = html;
        
        document.getElementById('total-display').textContent = `$${total.toFixed(2)}`;
        
        let hiddenFieldsHtml = '';
        selectedItems.forEach(item => {
            hiddenFieldsHtml += `<input type="hidden" name="product_ids" value="${item.id}">`;
            hiddenFieldsHtml += `<input type="hidden" name="quantities" value="${item.quantity}">`;
        });
        document.getElementById('hidden-fields-container').innerHTML = hiddenFieldsHtml;
        
        document.querySelectorAll('.remove-item').forEach(button => {
            button.addEventListener('click', function() {
                const productId = this.getAttribute('data-product-id');
                selectedItems = selectedItems.filter(item => item.id !== productId);
                updateBudgetDisplay();
            });
        });
    }
    
    function attachAddToBudgetListeners() {
        document.querySelectorAll('.add-to-budget').forEach(button => {
            if (!button.dataset.listenerAttached) {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    const productName = this.getAttribute('data-product-name');
                    const productPrice = parseFloat(this.getAttribute('data-product-price'));
                    const card = this.closest('.product-card-compact');
                    const quantityInput = card.querySelector('.quantity-input-compact');
                    const quantity = parseInt(quantityInput.value) || 1;
                    
                    const existingItemIndex = selectedItems.findIndex(item => item.id === productId);
                    if (existingItemIndex !== -1) {
                        selectedItems[existingItemIndex].quantity += quantity;
                    } else {
                        selectedItems.push({
                            id: productId,
                            name: productName,
                            price: productPrice,
                            quantity: quantity
                        });
                    }
                    
                    quantityInput.value = 1;
                    updateBudgetDisplay();
                });
                button.dataset.listenerAttached = 'true';
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        updateBudgetDisplay();
        attachAddToBudgetListeners();
    });
</script>
{% endblock %}