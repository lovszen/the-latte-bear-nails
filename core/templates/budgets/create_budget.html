{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1 class="admin-titulo">Crear Nuevo Presupuesto</h1>
        <div class="admin-actions">
            <a href="{% url 'budgets_list' %}" class="btn btn-rosa">‚Üê Volver a Mis Presupuestos</a>
        </div>
    </div>

    <div class="presupuesto-form-card">
        <form method="post" id="presupuestoForm">
            {% csrf_token %}
            
            <div class="form-section">
                <h3>Informaci√≥n del Presupuesto</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="titulo"><strong>T√≠tulo del Presupuesto:</strong></label>
                        <input type="text" id="titulo" name="title" class="form-control" 
                               placeholder="Ej: Presupuesto para evento especial" required>
                    </div>
                    <div class="form-group">
                        <label for="customer_name"><strong>Nombre del Cliente:</strong></label>
                        <input type="text" id="customer_name" name="customer_name" class="form-control" 
                               value="{{ request.user.get_full_name|default:request.user.username }}" required>
                    </div>
                    <div class="form-group">
                        <label for="customer_email"><strong>Email del Cliente:</strong></label>
                        <input type="email" id="customer_email" name="customer_email" class="form-control" 
                               value="{{ request.user.email }}" required>
                    </div>
                </div>
            </div>

            <!-- Cat√°logo de Productos Estilo Tienda -->
            <div class="productos-section">
                <h3>Seleccionar Productos</h3>
                <p class="section-description">Haz clic en los productos para agregarlos al presupuesto</p>
                
                <div class="tienda-grid">
                    {% for product in products %}
                    <div class="producto-card" data-product-id="{{ product.id }}" data-product-precio="{{ product.precio }}">
                        <div class="producto-imagen">
                            {% if product.imagen %}
                                <img src="{{ product.imagen.url }}" alt="{{ product.nombre }}">
                            {% else %}
                                <div class="sin-imagen">üì∑</div>
                            {% endif %}
                        </div>
                        
                        <div class="producto-info">
                            <h4 class="producto-nombre">{{ product.nombre }}</h4>
                            <p class="producto-descripcion">{{ product.descripcion|truncatewords:10 }}</p>
                            
                            <div class="producto-detalles">
                                <p><strong>Forma:</strong> {{ product.get_forma_display }}</p>
                                <p><strong>Color:</strong> {{ product.get_color_principal_display }}</p>
                                {% if product.color_secundario %}
                                <p><strong>Color Sec.:</strong> {{ product.get_color_secundario_display }}</p>
                                {% endif %}
                            </div>
                            
                            <div class="producto-precio">
                                <span class="precio">${{ product.precio }}</span>
                            </div>
                        </div>
                        
                        <div class="producto-acciones">
                            <button type="button" class="btn-agregar btn-rosa">
                                <i class="bi bi-plus-circle"></i> Agregar
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <p>No hay productos disponibles</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Productos Seleccionados -->
            <div class="seleccionados-section">
                <h3>Productos Seleccionados</h3>
                <div id="productosSeleccionados" class="seleccionados-grid">
                    <!-- Los productos seleccionados aparecer√°n aqu√≠ -->
                </div>
                
                <div class="empty-seleccion" id="emptySeleccion">
                    <p>No hay productos seleccionados. Haz clic en "Agregar" de los productos arriba.</p>
                </div>
            </div>

            <!-- Resumen del Presupuesto -->
            <div class="resumen-section">
                <h3>Resumen del Presupuesto</h3>
                <div class="resumen-details">
                    <div class="resumen-total">
                        <strong>Total:</strong>
                        <strong>$<span id="totalAmount">0.00</span></strong>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-latte">
                    <i class="bi bi-check-circle"></i> Crear Presupuesto
                </button>
                <a href="{% url 'budgets_list' %}" class="btn btn-rosa">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
            </div>

            <!-- Campos ocultos para el formulario -->
            <div id="hiddenFields"></div>
        </form>
    </div>
</div>

<!-- Template para producto seleccionado -->
<template id="productoSeleccionadoTemplate">
    <div class="producto-seleccionado" data-product-id="">
        <div class="producto-header">
            <h4 class="producto-nombre"></h4>
            <button type="button" class="btn-eliminar btn-danger btn-sm">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        
        <div class="producto-detalles-seleccionado">
            <div class="precio-info">
                <span class="precio-unitario">Precio: $<span class="precio-valor">0.00</span></span>
            </div>
            
            <div class="cantidad-control">
                <label>Cantidad:</label>
                <div class="cantidad-inputs">
                    <button type="button" class="btn-cantidad btn-menos">-</button>
                    <input type="number" class="cantidad-input" value="1" min="1" max="99">
                    <button type="button" class="btn-cantidad btn-mas">+</button>
                </div>
            </div>
            
            <div class="subtotal">
                <strong>Subtotal: $<span class="subtotal-valor">0.00</span></strong>
            </div>
        </div>
    </div>
</template>

<style>
.admin-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    background: linear-gradient(135deg, #fff5f5 0%, #fff0f6 100%);
    min-height: 100vh;
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding: 25px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(255, 212, 240, 0.15);
    border: 2px solid #ffd4f0;
}

.admin-titulo {
    color: #522b0b;
    margin: 0;
    font-size: 2rem;
}

.presupuesto-form-card {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 4px 20px rgba(255, 212, 240, 0.15);
    border: 2px solid #ffd4f0;
}

.form-section {
    margin-bottom: 40px;
    padding-bottom: 25px;
    border-bottom: 2px solid #ffd4f0;
}

.form-section h3 {
    color: #522b0b;
    margin-bottom: 20px;
    font-size: 1.5rem;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #522b0b;
    font-weight: 600;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid #ffd4f0;
    border-radius: 8px;
    font-size: 1rem;
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: #522b0b;
    box-shadow: 0 0 0 2px rgba(82, 43, 11, 0.1);
}

/* Estilo Tienda - Grid de Productos */
.tienda-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.producto-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(255, 212, 240, 0.2);
    overflow: hidden;
    transition: all 0.3s ease;
    border: 1px solid #ffd4f0;
    cursor: pointer;
}

.producto-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(255, 212, 240, 0.3);
}

.producto-imagen {
    height: 200px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #fff5f5 0%, #ffeef0 100%);
}

.producto-imagen img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.producto-card:hover .producto-imagen img {
    transform: scale(1.05);
}

.sin-imagen {
    padding: 40px;
    color: #ffd4f0;
    font-size: 2rem;
}

.producto-info {
    padding: 20px;
}

.producto-nombre {
    color: #522b0b;
    margin: 0 0 10px 0;
    font-size: 1.2rem;
    font-weight: 600;
}

.producto-descripcion {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 15px;
    line-height: 1.4;
}

.producto-detalles {
    margin-bottom: 15px;
}

.producto-detalles p {
    margin: 5px 0;
    font-size: 0.85rem;
    color: #8B4513;
}

.producto-precio {
    text-align: center;
    margin-top: 15px;
}

.precio {
    font-size: 1.3rem;
    font-weight: bold;
    color: #522b0b;
}

.producto-acciones {
    padding: 15px 20px;
    background: linear-gradient(135deg, #fff5f5 0%, #ffeef0 100%);
    border-top: 1px solid #ffd4f0;
}

.btn-agregar {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

/* Productos Seleccionados */
.seleccionados-section {
    margin: 40px 0;
    padding: 25px;
    background: #fff5f5;
    border-radius: 12px;
    border: 1px solid #ffd4f0;
}

.seleccionados-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

.producto-seleccionado {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(255, 212, 240, 0.2);
    border: 1px solid #ffd4f0;
}

.producto-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #ffd4f0;
}

.producto-header h4 {
    color: #522b0b;
    margin: 0;
    font-size: 1.1rem;
}

.producto-detalles-seleccionado {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    align-items: center;
}

.precio-info {
    color: #522b0b;
    font-weight: 500;
}

.cantidad-control label {
    display: block;
    margin-bottom: 5px;
    color: #522b0b;
    font-weight: 500;
}

.cantidad-inputs {
    display: flex;
    align-items: center;
    gap: 10px;
}

.btn-cantidad {
    width: 35px;
    height: 35px;
    border: 1px solid #ffd4f0;
    background: white;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #522b0b;
}

.btn-cantidad:hover {
    background: #ffd4f0;
}

.cantidad-input {
    width: 60px;
    text-align: center;
    padding: 5px;
    border: 1px solid #ffd4f0;
    border-radius: 5px;
}

.subtotal {
    grid-column: 1 / -1;
    text-align: right;
    padding-top: 10px;
    border-top: 1px solid #ffd4f0;
    color: #522b0b;
    font-size: 1.1rem;
}

.empty-seleccion {
    text-align: center;
    padding: 40px;
    color: #8B4513;
    font-style: italic;
}

.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 40px;
    color: #8B4513;
}

.resumen-section {
    background: #fff5f5;
    padding: 25px;
    border-radius: 10px;
    margin: 30px 0;
    border: 1px solid #ffd4f0;
}

.resumen-details {
    max-width: 300px;
    margin: 0 auto;
}

.resumen-total {
    display: flex;
    justify-content: space-between;
    font-size: 1.5rem;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 30px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-rosa {
    background: linear-gradient(135deg, #ffd4f0 0%, #ffc2e9 100%);
    color: #522b0b;
}

.btn-rosa:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(255, 212, 240, 0.3);
}

.btn-latte {
    background: linear-gradient(135deg, #522b0b 0%, #8B4513 100%);
    color: white;
}

.btn-latte:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(82, 43, 11, 0.3);
}

.btn-danger {
    background: #dc3545;
    color: white;
}

@media (max-width: 768px) {
    .admin-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .tienda-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
    
    .seleccionados-grid {
        grid-template-columns: 1fr;
    }
    
    .producto-detalles-seleccionado {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .form-actions {
        flex-direction: column;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productosSeleccionados = document.getElementById('productosSeleccionados');
    const emptySeleccion = document.getElementById('emptySeleccion');
    const totalAmountSpan = document.getElementById('totalAmount');
    const hiddenFields = document.getElementById('hiddenFields');
    const productoSeleccionadoTemplate = document.getElementById('productoSeleccionadoTemplate');
    const presupuestoForm = document.getElementById('presupuestoForm');
    
    let productosAgregados = new Map();
    
    // Agregar producto al hacer clic en "Agregar"
    document.querySelectorAll('.btn-agregar').forEach(btn => {
        btn.addEventListener('click', function() {
            const productoCard = this.closest('.producto-card');
            const productId = productoCard.dataset.productId;
            const productPrecio = parseFloat(productoCard.dataset.productPrecio);
            const productNombre = productoCard.querySelector('.producto-nombre').textContent;
            
            if (!productosAgregados.has(productId)) {
                agregarProductoSeleccionado(productId, productNombre, productPrecio);
                productosAgregados.set(productId, { cantidad: 1, precio: productPrecio });
                actualizarVista();
            }
        });
    });
    
    function agregarProductoSeleccionado(productId, nombre, precio) {
        const clone = productoSeleccionadoTemplate.content.cloneNode(true);
        const productoElement = clone.querySelector('.producto-seleccionado');
        
        productoElement.dataset.productId = productId;
        productoElement.querySelector('.producto-nombre').textContent = nombre;
        productoElement.querySelector('.precio-valor').textContent = precio.toFixed(2);
        productoElement.querySelector('.subtotal-valor').textContent = precio.toFixed(2);
        
        // Event listeners para los controles
        const btnEliminar = productoElement.querySelector('.btn-eliminar');
        const btnMenos = productoElement.querySelector('.btn-menos');
        const btnMas = productoElement.querySelector('.btn-mas');
        const cantidadInput = productoElement.querySelector('.cantidad-input');
        
        btnEliminar.addEventListener('click', function() {
            productosAgregados.delete(productId);
            productoElement.remove();
            actualizarVista();
        });
        
        btnMenos.addEventListener('click', function() {
            let cantidad = parseInt(cantidadInput.value);
            if (cantidad > 1) {
                cantidadInput.value = cantidad - 1;
                actualizarCantidadProducto(productId, cantidad - 1);
            }
        });
        
        btnMas.addEventListener('click', function() {
            let cantidad = parseInt(cantidadInput.value);
            cantidadInput.value = cantidad + 1;
            actualizarCantidadProducto(productId, cantidad + 1);
        });
        
        cantidadInput.addEventListener('input', function() {
            const cantidad = parseInt(this.value) || 1;
            this.value = Math.max(1, Math.min(99, cantidad));
            actualizarCantidadProducto(productId, this.value);
        });
        
        productosSeleccionados.appendChild(productoElement);
    }
    
    function actualizarCantidadProducto(productId, cantidad) {
        if (productosAgregados.has(productId)) {
            productosAgregados.get(productId).cantidad = cantidad;
            actualizarSubtotalProducto(productId);
            calcularTotal();
        }
    }
    
    function actualizarSubtotalProducto(productId) {
        const productoElement = document.querySelector(`.producto-seleccionado[data-product-id="${productId}"]`);
        if (productoElement) {
            const producto = productosAgregados.get(productId);
            const subtotal = producto.cantidad * producto.precio;
            productoElement.querySelector('.subtotal-valor').textContent = subtotal.toFixed(2);
        }
    }
    
    function actualizarVista() {
        if (productosAgregados.size > 0) {
            emptySeleccion.style.display = 'none';
            productosSeleccionados.style.display = 'grid';
        } else {
            emptySeleccion.style.display = 'block';
            productosSeleccionados.style.display = 'none';
        }
        calcularTotal();
        actualizarCamposOcultos();
    }
    
    function calcularTotal() {
        let total = 0;
        productosAgregados.forEach((producto, productId) => {
            total += producto.cantidad * producto.precio;
        });
        totalAmountSpan.textContent = total.toFixed(2);
    }
    
    function actualizarCamposOcultos() {
        // Limpiar campos ocultos anteriores
        hiddenFields.innerHTML = '';
        
        // Agregar campos ocultos para cada producto
        productosAgregados.forEach((producto, productId) => {
            const productIdField = document.createElement('input');
            productIdField.type = 'hidden';
            productIdField.name = 'product_ids';
            productIdField.value = productId;
            hiddenFields.appendChild(productIdField);
            
            const quantityField = document.createElement('input');
            quantityField.type = 'hidden';
            quantityField.name = 'quantities';
            quantityField.value = producto.cantidad;
            hiddenFields.appendChild(quantityField);
        });
    }
    
    actualizarVista();
});
</script>
{% endblock %}